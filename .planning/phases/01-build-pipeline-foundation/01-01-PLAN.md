---
phase: 01-build-pipeline-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/buildTokens.ts
  - dist/css/tokens.css
autonomous: true

must_haves:
  truths:
    - "Running `npm run build:tokens` creates dist/css/tokens.css without errors"
    - "Token references like {color-neutral-500} resolve to actual values (no literal curly braces in output)"
    - "All collections from manifest.json are represented in the CSS output"
    - "Running the build twice produces byte-identical output (deterministic)"
  artifacts:
    - path: "scripts/buildTokens.ts"
      provides: "Build script that reads manifest.json and orchestrates Style Dictionary"
      min_lines: 30
    - path: "dist/css/tokens.css"
      provides: "Combined CSS custom properties output"
      contains: ":root"
  key_links:
    - from: "scripts/buildTokens.ts"
      to: "src/tokens/manifest.json"
      via: "readFileSync + JSON.parse"
      pattern: "readFileSync.*manifest\\.json"
    - from: "scripts/buildTokens.ts"
      to: "style-dictionary"
      via: "new StyleDictionary constructor with source files from manifest"
      pattern: "new StyleDictionary"
    - from: "package.json"
      to: "scripts/buildTokens.ts"
      via: "npm run build:tokens script"
      pattern: "build:tokens.*buildTokens"
---

<objective>
Create the foundational build script that reads manifest.json, discovers all token files, and uses Style Dictionary v5 to output a single CSS file with resolved token references.

Purpose: Establish the core build pipeline that all subsequent phases build upon.
Output: Working `scripts/buildTokens.ts` and generated `dist/css/tokens.css`.
</objective>

<execution_context>
@/Users/tomoostewechel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomoostewechel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-pipeline-foundation/01-RESEARCH.md
@src/tokens/manifest.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build script with manifest-driven token discovery</name>
  <files>scripts/buildTokens.ts</files>
  <action>
Create `scripts/buildTokens.ts` using the Style Dictionary v5 async programmatic API.

The script must:

1. **Read manifest.json** — Parse `src/tokens/manifest.json` to discover all token files. The manifest has two top-level keys: `collections` (with nested modes) and `styles` (flat file arrays). Both must be processed.

2. **Flatten to source array with stable sorting** — Iterate `manifest.collections` entries sorted by collection name (localeCompare). For each collection, iterate mode entries sorted by mode name. Flatten all file paths. Then iterate `manifest.styles` entries sorted by key. Prepend `src/tokens/` to each filename. Sort the final combined array to ensure deterministic ordering.

3. **Create output directory** — `mkdirSync('dist/css', { recursive: true })` before build.

4. **Configure Style Dictionary v5** — Create a single `new StyleDictionary()` instance with:
   - `source`: the flattened, sorted source files array
   - `platforms.css.transformGroup`: `'css'` (includes name/kebab for CSS custom property naming)
   - `platforms.css.buildPath`: `'dist/css/'`
   - `platforms.css.files`: single file with `destination: 'tokens.css'` and `format: 'css/variables'`

5. **Build** — `await sd.buildAllPlatforms()`. The await is critical (v5 is async-first).

6. **Error handling** — Wrap in async function, catch errors, exit with code 1 on failure. Log discovered file count and success/failure message.

Important:
- Use ESM imports only (`import` not `require`) — package.json has `"type": "module"`
- Import from `'style-dictionary'` (default export) and `'fs'` (named: readFileSync, mkdirSync)
- Define a TypeScript `Manifest` interface matching the actual manifest.json structure (collections with modes, and styles as record of string arrays)
- Do NOT add any custom transforms or formats — use only Style Dictionary built-ins
- Do NOT use `outputReferences: true` yet — that is for Phase 2 when we have mode selectors. In Phase 1, let SD fully resolve all references to their end values.
  </action>
  <verify>
Run `npx tsx scripts/buildTokens.ts` and confirm:
1. Script exits with code 0
2. `dist/css/tokens.css` file is created
3. File contains `:root {` selector with CSS custom properties
4. No literal `{token-name}` references appear in output (grep for unresolved refs)
  </verify>
  <done>scripts/buildTokens.ts exists, is valid TypeScript, and executes without errors via tsx</done>
</task>

<task type="auto">
  <name>Task 2: Validate build output meets all Phase 1 requirements</name>
  <files>dist/css/tokens.css</files>
  <action>
Run the build and validate the output against all Phase 1 requirements:

1. **Run the build**: `npm run build:tokens`

2. **PIPE-01 (manifest processing)**: Verify all 8 collections from manifest.json are represented in output. Check for tokens from: primitives-color, color (light+dark), primitives-font, primitives-dimension, dimension, primitives-radius, radius (all 4 modes), typography. Also check that styles (typography.styles) are included.

3. **PIPE-02 (reference resolution)**: Grep the output for literal curly-brace references (`{`). There should be ZERO unresolved references. Every `{token-name}` reference should be resolved to a concrete value.

4. **PIPE-03 (kebab-case naming)**: Verify CSS custom properties use `--kebab-case` naming (e.g., `--color-neutral-500`, `--color-background-surface-default`). No camelCase or PascalCase in property names.

5. **PIPE-04 (single file)**: Confirm only `dist/css/tokens.css` exists (no other files generated).

6. **PIPE-05 (npm script)**: Confirm `npm run build:tokens` works (not just direct tsx invocation).

7. **QUAL-02 (no unresolved refs)**: Same as PIPE-02 check.

8. **QUAL-03 (deterministic)**: Run build twice, diff the outputs. They must be identical.

If any validation fails, fix the build script in Task 1's file (`scripts/buildTokens.ts`) to address the issue. Common fixes:
- Unresolved refs: Missing source files in the array (check manifest parsing includes styles section)
- Missing collections: Manifest parsing not covering all entries
- Non-deterministic: Source array not sorted consistently
  </action>
  <verify>
All 7 requirements validated:
- `npm run build:tokens` exits 0
- `dist/css/tokens.css` exists and is non-empty
- `grep -c '{' dist/css/tokens.css` shows 0 unresolved references (or only CSS syntax braces, not token refs)
- CSS properties are kebab-case
- Build is deterministic (two runs produce identical output)
  </verify>
  <done>dist/css/tokens.css contains resolved CSS custom properties from all manifest collections, builds deterministically via npm run build:tokens</done>
</task>

</tasks>

<verification>
Run these checks to verify the complete phase:

```bash
# 1. Build succeeds
npm run build:tokens

# 2. Output file exists and has content
test -s dist/css/tokens.css && echo "PASS: file exists" || echo "FAIL"

# 3. No unresolved token references (look for {word} patterns that aren't CSS syntax)
grep -P '\{[a-z]' dist/css/tokens.css | head -5
# Should return nothing

# 4. Has CSS custom properties
grep -c '\-\-' dist/css/tokens.css
# Should return a large number (100+)

# 5. Deterministic output
npm run build:tokens
cp dist/css/tokens.css /tmp/tokens-run1.css
npm run build:tokens
diff dist/css/tokens.css /tmp/tokens-run1.css
# Should show no differences
```
</verification>

<success_criteria>
1. `npm run build:tokens` completes successfully (exit code 0)
2. `dist/css/tokens.css` is generated with CSS custom properties under `:root`
3. Zero unresolved `{token-name}` references in output
4. All manifest.json collections represented in output
5. Two consecutive builds produce byte-identical output
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-pipeline-foundation/01-01-SUMMARY.md`
</output>
