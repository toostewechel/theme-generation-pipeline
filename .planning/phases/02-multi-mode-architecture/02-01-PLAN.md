---
phase: 02-multi-mode-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/buildTokens.ts
  - dist/css/tokens.css
autonomous: true

must_haves:
  truths:
    - "CSS output contains :root selector with light color tokens and default radius tokens as defaults"
    - "CSS output contains [data-color-mode='light'] selector with light color tokens"
    - "CSS output contains [data-color-mode='dark'] selector with dark color tokens"
    - "CSS output contains [data-radius-mode='sharp'], [data-radius-mode='default'], [data-radius-mode='rounded'], and [data-radius-mode='pill'] selectors"
    - "Selectors appear in correct order: :root first, then [data-*] overrides"
    - "Same semantic token name (e.g., --color-background-surface-default) appears in both :root and [data-color-mode='dark'] with different values"
  artifacts:
    - path: "scripts/buildTokens.ts"
      provides: "Build script with css/advanced format and multi-mode rules"
      contains: "css/advanced"
    - path: "dist/css/tokens.css"
      provides: "Single CSS file with multiple selector blocks"
      contains: "data-color-mode"
  key_links:
    - from: "scripts/buildTokens.ts"
      to: "dist/css/tokens.css"
      via: "css/advanced format with rules array"
      pattern: "format.*css/advanced"
---

<objective>
Update the build script to output multi-mode CSS with data-attribute selectors for color modes (light/dark) and radius modes (sharp/default/rounded/pill) using style-dictionary-utils' css/advanced format with rules.

Purpose: Enable theme switching via data-attributes on HTML elements. Light colors and default radius serve as defaults in :root, while explicit [data-*] selectors allow runtime mode switching via CSS cascade.

Output: Updated scripts/buildTokens.ts and rebuilt dist/css/tokens.css with multiple selector blocks.
</objective>

<execution_context>
@/Users/tomoostewechel/.claude/agents/gsd-executor.md
@/Users/tomoostewechel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-mode-architecture/02-RESEARCH.md
@.planning/phases/01-build-pipeline-foundation/01-01-SUMMARY.md
@scripts/buildTokens.ts
@src/tokens/manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update build script to use css/advanced format with multi-mode rules</name>
  <files>scripts/buildTokens.ts</files>
  <action>
Update the Style Dictionary configuration in scripts/buildTokens.ts to use the `css/advanced` format from style-dictionary-utils instead of the current `css/variables` format.

Replace the current `files` array in the platform config with a single file entry using `css/advanced` format and a `rules` array. The rules array must be ordered so that `:root` rules come FIRST (establishing defaults), followed by `[data-*]` override rules.

**Rules array (in this exact order):**

1. `:root` — matcher: `token.filePath.includes('color.light.tokens.json')` (light color as default)
2. `:root` — matcher: `token.filePath.includes('radius.default.tokens.json')` (default radius as default)
3. `[data-color-mode='light']` — matcher: `token.filePath.includes('color.light.tokens.json')`
4. `[data-color-mode='dark']` — matcher: `token.filePath.includes('color.dark.tokens.json')`
5. `[data-radius-mode='sharp']` — matcher: `token.filePath.includes('radius.sharp.tokens.json')`
6. `[data-radius-mode='default']` — matcher: `token.filePath.includes('radius.default.tokens.json')`
7. `[data-radius-mode='rounded']` — matcher: `token.filePath.includes('radius.rounded.tokens.json')`
8. `[data-radius-mode='pill']` — matcher: `token.filePath.includes('radius.pill.tokens.json')`

**Options to set:**
- `outputReferences: true` — preserve CSS var() reference chains instead of resolving to static values
- `selector: ':root'` — fallback selector for tokens not matching any rule (primitives, typography, dimension)

**Keep everything else unchanged** — manifest reading, source file discovery, sorting, directory creation, error handling.

**Important:** The `css/advanced` format is already available from the `style-dictionary-utils` import (already in use). No new imports needed.

Do NOT use `filter` — use `rules` with `matcher` functions. Filters exclude tokens; rules include the same token under multiple selectors.

Expect Style Dictionary collision warnings for tokens that appear in both light and dark files — these are intentional and safe to ignore.
  </action>
  <verify>Run `npm run build:tokens` — should complete without errors (collision warnings are expected and OK).</verify>
  <done>Build script uses css/advanced format with 8 rules. Build completes successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Verify multi-mode CSS output structure</name>
  <files>dist/css/tokens.css</files>
  <action>
Run `npm run build:tokens` and verify the generated dist/css/tokens.css meets all Phase 2 requirements.

**Verify these selectors exist in the output (in this order):**
1. `:root { ... }` — contains light color tokens AND default radius tokens AND primitive tokens
2. `[data-color-mode='light'] { ... }` — contains light color semantic tokens
3. `[data-color-mode='dark'] { ... }` — contains dark color semantic tokens
4. `[data-radius-mode='sharp'] { ... }` — contains sharp radius tokens
5. `[data-radius-mode='default'] { ... }` — contains default radius tokens
6. `[data-radius-mode='rounded'] { ... }` — contains rounded radius tokens
7. `[data-radius-mode='pill'] { ... }` — contains pill radius tokens

**Verify token duplication works correctly:**
- The token `--color-background-surface-default` should appear in `:root`, `[data-color-mode='light']`, AND `[data-color-mode='dark']` — same name, potentially different values between light and dark.
- The token `--radius-intensity` (or equivalent radius tokens) should appear in `:root` AND each `[data-radius-mode='*']` selector.

**Verify ordering:**
- `:root` block(s) appear BEFORE any `[data-*]` blocks in the file.

**Verify outputReferences:**
- Semantic color tokens reference primitives via `var()` syntax (e.g., `--color-text-default: var(--color-neutral-900)`) rather than static resolved values.

If any of these checks fail, fix the build script configuration and rebuild until all pass.
  </action>
  <verify>
Run these checks against dist/css/tokens.css:
- `grep -c "data-color-mode='light'" dist/css/tokens.css` returns 1 (one selector block)
- `grep -c "data-color-mode='dark'" dist/css/tokens.css` returns 1
- `grep -c "data-radius-mode='sharp'" dist/css/tokens.css` returns 1
- `grep -c "data-radius-mode='default'" dist/css/tokens.css` returns 1
- `grep -c "data-radius-mode='rounded'" dist/css/tokens.css` returns 1
- `grep -c "data-radius-mode='pill'" dist/css/tokens.css` returns 1
- `grep -c ":root" dist/css/tokens.css` returns at least 1
- Confirm :root appears before [data-*] selectors in file
  </verify>
  <done>dist/css/tokens.css contains all 7+ selector blocks in correct order, with same-named tokens appearing under multiple selectors, and outputReferences producing var() chains.</done>
</task>

</tasks>

<verification>
Run `npm run build:tokens` and verify:
1. Build completes without errors (collision warnings acceptable)
2. dist/css/tokens.css contains :root, [data-color-mode='light'], [data-color-mode='dark'], and all 4 radius mode selectors
3. :root appears first in the file, [data-*] selectors follow
4. Same token names appear in multiple selectors (light vs dark, sharp vs pill)
5. Semantic tokens use var() references to primitives (outputReferences working)
6. Build is deterministic (two consecutive runs produce identical output)
</verification>

<success_criteria>
- `npm run build:tokens` succeeds
- dist/css/tokens.css has :root with light color + default radius defaults
- dist/css/tokens.css has [data-color-mode='light'] and [data-color-mode='dark'] selectors
- dist/css/tokens.css has [data-radius-mode='sharp|default|rounded|pill'] selectors
- :root before [data-*] in file order
- Token var() chains preserved (outputReferences)
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-mode-architecture/02-01-SUMMARY.md`
</output>
