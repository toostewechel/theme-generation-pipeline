---
phase: 03-value-transformations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/buildTokens.ts
  - dist/css/tokens.css
autonomous: true

must_haves:
  truths:
    - "Dimension tokens (space-*, size-*) output in rem units (e.g., --space-4: 1rem)"
    - "Tokens with $description: 'unitless' output as raw numbers without units (e.g., --radius-scale-md: 1)"
    - "Color primitives still output as hex values under :root"
    - "Multi-mode selectors (data-color-mode, data-radius-mode) still work correctly"
    - "Semantic dimension tokens using var() references still resolve correctly"
  artifacts:
    - path: "scripts/buildTokens.ts"
      provides: "Custom dimension/unitless transform + explicit transforms array + rem config"
      contains: "dimension/unitless"
    - path: "dist/css/tokens.css"
      provides: "Generated CSS with rem dimensions and unitless values"
  key_links:
    - from: "scripts/buildTokens.ts"
      to: "dist/css/tokens.css"
      via: "Style Dictionary build"
      pattern: "outputUnit.*rem"
---

<objective>
Add value transformations to convert DTCG dimension tokens from px to rem and handle unitless dimension exceptions.

Purpose: Dimension tokens currently output as raw px values (e.g., `--space-4: 16px`). Consumers need rem units for responsive scaling, and unitless tokens (radius scale, opacity) must output as raw numbers without units.

Output: Updated `scripts/buildTokens.ts` with custom transform and platform config; regenerated `dist/css/tokens.css` with correct rem dimensions and unitless values.
</objective>

<execution_context>
@/Users/tomoostewechel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomoostewechel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-mode-architecture/02-01-SUMMARY.md
@.planning/phases/03-value-transformations/03-RESEARCH.md
@scripts/buildTokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register custom unitless transform and configure rem output</name>
  <files>scripts/buildTokens.ts</files>
  <action>
Modify `scripts/buildTokens.ts` to add value transformations. Three changes needed:

**1. Register custom `dimension/unitless` transform** (before `buildTokens()` function):

```typescript
StyleDictionary.registerTransform({
  name: 'dimension/unitless',
  type: 'value',
  transitive: true,
  filter: (token) => {
    return token.$type === 'dimension' && token.$description === 'unitless';
  },
  transform: (token) => {
    if (typeof token.$value === 'object' && token.$value.value !== undefined) {
      return String(token.$value.value);
    }
    return String(token.$value);
  }
});
```

**2. Replace `transformGroup: 'css/extended'` with explicit `transforms` array** in ALL 7 build configurations (root, light, dark, 4 radius modes). Cannot mix `transformGroup` with custom `transforms` — must list all transforms explicitly.

The transforms array (order matters — `dimension/unitless` BEFORE `dimension/css`):
```typescript
transforms: [
  'attribute/cti',
  'name/kebab',
  'time/seconds',
  'html/icon',
  'size/rem',
  'color/css',
  'asset/url',
  'fontFamily/css',
  'cubicBezier/css',
  'strokeStyle/css/shorthand',
  'border/css/shorthand',
  'typography/css/shorthand',
  'transition/css/shorthand',
  'shadow/css/shorthand',
  'dimension/unitless',
  'dimension/css',
  'shadow/css',
  'typography/css',
  'fontWeight/number',
  'border/css',
],
```

**3. Add platform options for rem conversion** to ALL 7 build configurations:
```typescript
outputUnit: 'rem',
basePxFontSize: 16,
```

To avoid repeating the transforms array and platform options 7 times, extract a shared platform config object:
```typescript
const sharedPlatformConfig = {
  transforms: [/* the array above */],
  outputUnit: 'rem',
  basePxFontSize: 16,
};
```

Then spread `...sharedPlatformConfig` into each build's `platforms.css` config alongside `buildPath`, `files`, etc.

**Important:** Do NOT change the multi-build architecture or file filtering logic from Phase 2. Only change the transform configuration and add the custom transform registration.
  </action>
  <verify>
Run `npm run build:tokens` — must complete successfully without errors.

Then verify the output:
1. `grep 'rem' dist/css/tokens.css | head -5` — dimension tokens should show rem units (e.g., `--space-4: 1rem`)
2. `grep 'radius-scale' dist/css/tokens.css` — should show raw numbers without units (e.g., `--radius-scale-md: 1`)
3. `grep 'radius-intensity' dist/css/tokens.css` — should show raw numbers (e.g., `--radius-intensity: 1`)
4. `grep 'color-neutral-0' dist/css/tokens.css` — should still show hex color `#fff`
5. `grep 'disabled-opacity' dist/css/tokens.css` — should show raw number (e.g., `0.5`)
6. `grep "data-color-mode" dist/css/tokens.css` — multi-mode selectors still present
7. `grep "data-radius-mode" dist/css/tokens.css` — radius mode selectors still present

**Fail conditions:**
- Any dimension token still showing `px` (except inside var() references or as 0px)
- Any unitless token showing a unit suffix
- Colors changed from hex format
- Missing mode selectors
  </verify>
  <done>
All dimension tokens output in rem (--space-4: 1rem, --size-4: 1rem, --radius-unit: 0.25rem). All tokens with $description: "unitless" output as raw numbers (--radius-scale-md: 1, --radius-intensity: 1, --color-state-disabled-opacity: 0.5). Colors remain as hex. Multi-mode architecture preserved.
  </done>
</task>

</tasks>

<verification>
Run `npm run build:tokens` and verify `dist/css/tokens.css`:

1. **DIMS-01 (px-to-rem):** `--space-4: 1rem` (was `16px`), `--space-1: 0.25rem` (was `4px`)
2. **DIMS-02 (unitless):** `--radius-scale-md: 1` (was `1px`), `--radius-intensity: 1` (was `1px`), `--color-state-disabled-opacity: 0.5` (was `0.5px`)
3. **DIMS-03 (primitives in :root):** `--space-*` and `--size-*` tokens present in `:root` block
4. **COLR-01 (colors):** `--color-neutral-500: #a5a6ab` (unchanged hex)
5. **COLR-02 (color primitives in :root):** `--color-neutral-*`, `--color-brand-*` etc. present in `:root`
6. **RADI-01 (radius primitives in :root):** `--radius-unit`, `--radius-scale-*`, `--radius-cap-*` present in `:root`
7. **Multi-mode preserved:** `[data-color-mode='light']`, `[data-color-mode='dark']`, `[data-radius-mode='*']` selectors all present
8. **Semantic references:** `--spacing-component-gap-xs: var(--space-1)` still using var() references
</verification>

<success_criteria>
- `npm run build:tokens` passes without errors
- Dimension tokens use rem units (16px base)
- Unitless tokens output raw numbers
- Colors remain hex
- All Phase 2 multi-mode selectors preserved
- var() reference chains intact
</success_criteria>

<output>
After completion, create `.planning/phases/03-value-transformations/03-01-SUMMARY.md`
</output>
